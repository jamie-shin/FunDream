<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="dao.IProjectDao">

	<select id="selectAllProjects" resultType="project">
		select * from Project
	</select>
	
	<select id="selectEndProject" resultType="project">
	<![CDATA[
		select * from project where (p_startdate <= now() or p_enddate <= now()) and p_approval=2 order by p_enddate limit 3
		]]>
	</select>

	<select id="selectNewProject" resultType="project">
		<![CDATA[
		select * from project where (p_startdate <= now() or p_enddate <= now()) and p_approval=2 order by p_startdate desc limit 3
		]]>
	</select>
	
	<select id="selectSuccessProject" resultType="project">
	<![CDATA[
		select * from project where (p_startdate <= now() or p_enddate <= now()) and p_approval=2 and p_target/p_status not in ('0') order by (p_target/p_status) limit 3
		]]>
	</select>
	
	<sql id="mainImg">
		<if test="p_mainimg == null || p_mainimg == ''">
			"img/user.png"
		</if>
		<if test="p_mainimg != null">
			#{p_mainimg}
		</if>
	</sql>

	<insert id="insertProject" parameterType="project" useGeneratedKeys="true" keyProperty="p_index">
		insert into Project (m_id, p_approval, p_createdate, p_status, p_calculate) values (#{m_id}, 4, now(), 0, 0);
	</insert>
	
	<select id="selectOneProjectByIndex" parameterType="int" resultType="project">
		select * from Project where p_index=#{p_index}
	</select>
	
	<select id="selectProjectsById" parameterType="int" resultType="project">
		select * from Project where m_id=#{m_id}
	</select>
	
	<update id="updateBasicInfo" parameterType="project">
		update Project set ct_index=#{ct_index}, p_name=#{p_name}, p_mainImg=<include refid="mainImg"/>, p_type=#{p_type}, p_target=#{p_target}, p_startdate=#{p_startdate}, p_enddate=#{p_enddate}, p_age=#{p_age} where p_index=#{p_index}
	</update>
	
	<update id="updatePolicy" parameterType="project">
		update Project set p_policy=#{p_policy} where p_index=#{p_index}
	</update>
	
	<select id="selectProject_accept" resultType="project" parameterType="java.util.HashMap">
		
			select * from project where 
			<if test="sort==1"><![CDATA[(p_startdate <= now() or p_enddate <= now())]]> and p_approval=2 order by p_startdate desc </if>
			<if test="sort==2"><![CDATA[(p_startdate <= now() or p_enddate <= now())]]> and p_approval=2 order by p_enddate</if>
			<if test="sort==3"><![CDATA[(p_startdate <= now() or p_enddate <= now()) and p_approval=2 and p_target/p_status not in ('0') order by (p_target/p_status)]]></if> limit 0,9
		
	</select>
	
	<select id="selectProject_more" resultType="project" parameterType="int">
		<![CDATA[
			select * from project where (p_startdate <= now() or p_enddate <= now()) and p_approval=2 order by p_startdate desc limit #{num},9
		]]>
	</select>
	
	<select id="selectProjectByKeywordOrCt" resultType="project" parameterType="java.util.HashMap">
		<![CDATA[
			select * from project where (p_startdate <= now() or p_enddate <= now()) and p_approval=2]]>
				<if test="sort == 1">
				<if test="ct_index != 0 "> AND ct_index= #{ct_index} </if> 
				<if test="keyword != null or keyword !='' "> AND p_name like '%${keyword}%' </if>
				order by p_startdate desc limit 0,9</if>
				
				<if test="sort == 2">
				<if test="ct_index != 0 "> AND ct_index= #{ct_index} </if> 
				<if test="keyword != null or keyword !='' "> AND p_name like '%${keyword}%' </if>
				order by p_enddate limit 0,9</if>
				
				<if test="sort==3">
				<if test="ct_index != 0 "> AND ct_index= #{ct_index} </if> 
				<if test="keyword != null or keyword !='' "> AND p_name like '%${keyword}%' </if>
				and p_target/p_status not in ('0') order by (p_target/p_status) limit 0,9
				</if>
				
	</select>
</mapper>